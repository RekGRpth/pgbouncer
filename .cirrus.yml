env:
  CIRRUS_CLONE_SUBMODULES: true
  DEBIAN_FRONTEND: noninteractive
  LANG: C
  PGVERSION: 14

task:
  name: Linux (Debian/Ubuntu)
  matrix:
    - container:
        image: ubuntu:20.04
    - container:
        image: ubuntu:20.04
      env:
        configure_args: '--with-cares --with-pam'
    - container:
        image: ubuntu:20.04
      env:
        configure_args: '--with-udns --without-openssl'
    - container:
        image: ubuntu:20.04
      env:
        configure_args: '--disable-evdns'
    - container:
        image: ubuntu:20.04
      env:
        CC: clang
    - container:
        image: ubuntu:20.04
      env:
        CFLAGS: -fno-sanitize-recover=all -fsanitize=undefined -fsanitize-address-use-after-scope -fno-sanitize=shift
    - container:
        image: ubuntu:20.04
      env:
        use_valgrind: yes
        CFLAGS: -O0 -g
    - container:
        image: ubuntu:20.04
      env:
        use_valgrind: yes
        CFLAGS: -O0 -g
        PGVERSION: 9.6
    - container:
        image: ubuntu:20.04
      env:
        use_scan_build: yes
    - arm_container:
        image: ubuntu:20.04
    - container:
        image: ubuntu:22.04
    - container:
        image: ubuntu:18.04
      env:
        PGVERSION: 10
    - container:
        image: ubuntu:16.04
      env:
        PGVERSION: 9.6
    - container:
        image: debian:stable
      env:
        PGVERSION: 13
    - container:
        image: debian:oldstable
      env:
        PGVERSION: 11
  setup_script:
    - apt-get update
    - apt-get -y install curl gnupg lsb-release
    - curl https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add -
    - echo "deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main" | tee /etc/apt/sources.list.d/pgdg.list
    - apt-get update
    - pkgs="autoconf automake cpio libc-ares-dev libevent-dev libssl-dev libsystemd-dev libtool libudns-dev make pandoc postgresql-$PGVERSION pkg-config python3"
    - case $CC in clang) pkgs="$pkgs clang";; esac
    - if [ x"$use_valgrind" = x"yes" ]; then pkgs="$pkgs valgrind"; fi
    - if [ x"$use_scan_build" = x"yes" ]; then pkgs="$pkgs clang-tools"; fi
    - apt-get -y install $pkgs
    - useradd user
    - chown -R user .
  build_script:
    - su user -c "./autogen.sh"
    - su user -c "${use_scan_build:+scan-build} ./configure --prefix=$HOME/install --enable-cassert --enable-werror --without-cares --with-systemd $configure_args"
    - su user -c "${use_scan_build:+scan-build} make"
  test_script:
    - |
      if [ x"$use_valgrind" = x"yes" ]; then
        export BOUNCER_EXE_PREFIX="valgrind --quiet --leak-check=full --show-reachable=no --track-origins=yes --error-markers=VALGRIND-ERROR-BEGIN,VALGRIND-ERROR-END --log-file=/tmp/valgrind.%p.log"
      fi
    - su user -c "PATH=/usr/lib/postgresql/${PGVERSION}/bin:$PATH make check"
    - |
      if [ x"$use_valgrind" = x"yes" ]; then
        if grep -q VALGRIND-ERROR /tmp/valgrind.*.log; then
          cat /tmp/valgrind.*.log
          exit 1
        fi
      fi
  install_script:
    - make install
  dist_script:
    - make dist
    - PACKAGE_VERSION=$(sed -n 's/PACKAGE_VERSION = //p' config.mak)
    - tar -x -v -f pgbouncer-${PACKAGE_VERSION}.tar.gz
    - cd pgbouncer-${PACKAGE_VERSION}/
    - ./configure --prefix=$HOME/install2 --enable-werror --without-cares $configure_args
    - make
    - make install
  tarball_artifacts:
    path: "pgbouncer-*.tar.gz"
  always:
    configure_artifacts:
      path: "config.log"
      type: text/plain
